# Домашнее задание №4 - Работа с базами данных, пользователями и правами  

1. В VirutalBox с установленной Ubuntu Server 24.04 и PostgreSQL 16 создан новый кластер  
	> \$ sudo pg_createcluster 16 hw04   
	> Creating new PostgreSQL cluster 16/hw04 ...  
	> ...  
	> ```
	> Ver Cluster Port Status Owner    Data directory              Log file
	> 16  hw04    5433 down   postgres /var/lib/postgresql/16/hw04 /var/log/postgresql/postgresql-16-hw04.log  
	> ```    

2. Успешное создание кластера проверено командой  
	> \$ pg_lsclusters  
	> ```  
	> Ver Cluster Port Status Owner    Data directory              Log file  
	> 16  hw04    5433 down   postgres /var/lib/postgresql/16/hw04 /var/log/postgresql/postgresql-16-hw04.log  
	> 16  main    5432 online postgres /mnt/data/main              /var/log/postgresql/postgresql-16-main.log  
	> ```

3. Кластрер запущен и выполнено подключение к нему под пользователем postgres  
	> \$ sudo pg_ctlcluster 16 hw04 start  
	> \$ sudo -u postgres psql -p 5433  
	> psql (16.9 (Ubuntu 16.9-0ubuntu0.24.04.1))  
	> Type "help" for help.  
	>  
	> postgres=#  

4.  Создана БД testdb и выполнено подключение к данной БД  
	> postgres=# create database testdb;  
	> CREATE DATABASE  
	> postgres=# \c testdb  
	> You are now connected to database "testdb" as user "postgres".  
	> testdb=#   

5. Создана новая схема testnm  
	> testdb=# create schema testnm;  
	> CREATE SCHEMA  

6. Создана новая таблица и в нее вставлена строка  
	> testdb=# create table t1 (c1 integer);  
	> CREATE TABLE  
	> testdb=# insert into t1 values(1);  
	> INSERT 0 1  

7. Создана роль readonly, которой выданы права на подключение к БД testdb, использование схемы testnm и права на выполнение запроса SELECT для таблиц схемы testnm  
	> testdb=# create role readonly;  
	> CREATE ROLE  
	> testdb=# grant connect on database testdb to readonly;  
	> GRANT  
	> testdb=# grant usage on schema testnm to readonly;  
	> GRANT  
	> testdb=# grant select on all tables in schema testnm to readonly;  
	> GRANT  

8. Создан пользователь testread и он "включен в группу" readonly (назанчена роль readonly)  
	> testdb=# create user testread with password 'test123';  
	> CREATE ROLE  
	> testdb=# grant readonly to testread;  
	> GRANT ROLE  

9. Произведено подключение к серверу PostgreSQL под пользователем testread
	> psql -U testread -d testdb -h localhost -p 5433  
	> Password for user testread:  
	> psql (16.9 (Ubuntu 16.9-0ubuntu0.24.04.1))  
	> SSL connection (protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, compression: off)  
	> Type "help" for help.  
	>  
	> testdb=>  

10. Выполнил запрос к БД testdb. Запрос завершился неудачно, т.к. роли readonly выданы права на подключение к testdb, но права на select выданы для схемы testnm, а таблица t1 по умолчанию (таблица создана без явного указания схемы) находится в схеме public к которой прав на выполение select у пользователя testread и группы readonly нет  
	> testdb=> select * from t1;  
	> ERROR:  permission denied for table t1  
	> testdb=> \d+
	> ```
	>                                     List of relations
	>  Schema | Name | Type  |  Owner   | Persistence | Access method |    Size    | Description   
	> --------+------+-------+----------+-------------+---------------+------------+-------------  
	>  public | t1   | table | postgres | permanent   | heap          | 8192 bytes |   
	> (1 row)  

11. Передподключился под пользователем postgres и удалил таблицу t1  
	> $ sudo -u postgres psql -p 5433  
	> psql (16.9 (Ubuntu 16.9-0ubuntu0.24.04.1))  
	> Type "help" for help.  
	>   
	> postgres=# \c testdb  
	> You are now connected to database "testdb" as user "postgres".  
	> testdb=# drop table t1;  
	> DROP TABLE  

12. Пересоздал таблицу с явным указанием схемы testnm  
	> testdb=# create table testnm.t1 (c1 integer);  
	> CREATE TABLE  
	> testdb=# insert into testnm.t1 values (1);  
	> INSERT 0 1  
 
13. Подключился под пользователем testread и попытался выполнить select - снова неудачно, т.к. таблица новая права на нее установлены по умолчанию, ранее выданные права на схему testnm на эту таблицу не распространяются  
	> \$ psql -U testread -h localhost -p 5433 -d testdb  
	> Password for user testread:   
	> psql (16.9 (Ubuntu 16.9-0ubuntu0.24.04.1))  
	> SSL connection (protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, compression: off)  
	> Type "help" for help.  
	>   
	> testdb=> select from testnm.t1;  
	> ERROR:  permission denied for table t1  
 
14. Установил права по умолчанию для схемы testnm, но они будут применятся только для вновь созданных таблиц, для уже существующих (как t1) нужно выдать права отдельно  
	> testdb=> alter default privileges in schema testnm grant select on tables to readonly;  
	> ALTER DEFAULT PRIVILEGES  
	> testdb=> select * from testnm.t1;  
	> ERROR:  permission denied for table t1  

15. Выда права для группы readonly на чтение таблицы t1		
	> gl@gl:~$ sudo -u postgres psql -p 5433  
	> psql (16.9 (Ubuntu 16.9-0ubuntu0.24.04.1))  
	> Type "help" for help.  
	>   
	> postgres=# \c testdb  
	> You are now connected to database "testdb" as user "postgres".  
	> testdb=# grant select on table testnm.t1 to readonly;  
	> GRANT  
 
16. Чтение таблицы прошло успешно
	> $ psql -U testread -d testdb -p 5433 -h localhost  
	> Password for user testread:  
	> psql (16.9 (Ubuntu 16.9-0ubuntu0.24.04.1))  
	> SSL connection (protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, compression: off)  
	> Type "help" for help.  
	> 		
	> testdb=> select * from testnm.t1;  
	> ```
	>  c1  
	> ----
	>   1
	> (1 row)
	> ```  

17. Попытка создать новую таблицу не удалась (ни в схеме public, как в привденной в ДЗ команде, ни в схеме testnm), что логично, т.к. изменены только права по умолчанию на выполнение select 
	> testdb=> create table t2(c1 integer);  
	> ERROR:  permission denied for schema public  
	> LINE 1: create table t2(c1 integer);  
	>                      ^  
	> testdb=> create table testnm.t2(c1 integer);  
	> ERROR:  permission denied for schema testnm  
	> LINE 1: create table testnm.t2(c1 integer);  
	>                      ^  




